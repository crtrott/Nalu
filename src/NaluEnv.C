/*------------------------------------------------------------------------*/
/*  Copyright 2014 Sandia Corporation.                                    */
/*  This software is released under the license detailed                  */
/*  in the file, LICENSE, which is located in the top-level Nalu          */
/*  directory structure                                                   */
/*------------------------------------------------------------------------*/

#include <NaluEnv.h>

#include <mpi.h>
#include <fstream>
#include <iostream>
#include <string>
#include <Kokkos_Core.hpp>

namespace sierra{
namespace nalu{

//==========================================================================
// Class Definition
//==========================================================================
// NaluEnv - manage parallel and parallel output in Nalu
//==========================================================================
//--------------------------------------------------------------------------
//-------- constructor -----------------------------------------------------
//--------------------------------------------------------------------------
NaluEnv::NaluEnv()
  : parallelCommunicator_(MPI_COMM_WORLD),
    pSize_(-1),
    pRank_(-1),
    naluLogStream_(&std::cout),
    naluParallelStream_(&std::cout)
{
  // initialize
  MPI_Comm_size(parallelCommunicator_, &pSize_);
  MPI_Comm_rank(parallelCommunicator_, &pRank_);
}

//--------------------------------------------------------------------------
//-------- self ------------------------------------------------------------
//--------------------------------------------------------------------------
NaluEnv &NaluEnv::self()
{
  static NaluEnv s;
  return s;
}

//--------------------------------------------------------------------------
//-------- naluOutputP0 ----------------------------------------------------
//--------------------------------------------------------------------------
std::ostream &
NaluEnv::naluOutputP0()
{
  return *naluLogStream_;
}

//--------------------------------------------------------------------------
//-------- naluOutput ------------------------------------------------------
//--------------------------------------------------------------------------
std::ostream &
NaluEnv::naluOutput()
{
  return *naluParallelStream_;
}

//--------------------------------------------------------------------------
//-------- parallel_size ---------------------------------------------------
//--------------------------------------------------------------------------
int
NaluEnv::parallel_size()
{
  return pSize_;
}

//--------------------------------------------------------------------------
//-------- parallel_rank ---------------------------------------------------
//--------------------------------------------------------------------------
int
NaluEnv::parallel_rank()
{
  return pRank_;
}

//--------------------------------------------------------------------------
//-------- parallel_comm ---------------------------------------------------
//--------------------------------------------------------------------------
MPI_Comm
NaluEnv::parallel_comm()
{
  return parallelCommunicator_;
}

//--------------------------------------------------------------------------
//-------- set_log_file_stream ---------------------------------------------
//--------------------------------------------------------------------------
void
NaluEnv::set_log_file_stream(std::string naluLogName)
{
  if ( pRank_ == 0 ) {
    naluStreamBuffer_.open(naluLogName.c_str(), std::ios::out);
    naluLogStream_->rdbuf(&naluStreamBuffer_);
  }
  else {
    naluLogStream_->rdbuf(&naluEmptyStreamBuffer_);
  }
}

//--------------------------------------------------------------------------
//-------- close_log_file_stream -------------------------------------------
//--------------------------------------------------------------------------
void
NaluEnv::close_log_file_stream()
{
  if ( pRank_ == 0 ) {
    naluStreamBuffer_.close();
  }  
}

//--------------------------------------------------------------------------
//-------- destructor ------------------------------------------------------
//--------------------------------------------------------------------------
NaluEnv::~NaluEnv()
{
  close_log_file_stream();
  
  Kokkos::finalize();
  // shut down MPI
  MPI_Finalize();
}

} // namespace nalu
} // namespace Sierra
